---
title: "Lab2 Instruction"
author: "Jun Cai"
date: "September 18, 2015"
output:
  pdf_document:
    includes:
      in_header: header.tex
    latex_engine: xelatex
  html_document:
    keep_md: yes
---

### Note

- All R codes are present in boxes with grey background. You can run them in your R Console. Lines leading by `##` are outputs of R codes.

- All R codes are run correctly on my own Mac OS X. When you try them on your own computer, please customize your own working directory.

- The functions in **bold** are recommended to use in your data analysis.

- The Lab Instruction in different formats including .Rmd, .md, .html and .pdf are available on my [GitHub](https://github.com/caijun/DAE/tree/master/Lab2). For your convenience, the data used and results generated in the Lab are also provided in the Github.

Lab2 contains basics for file and directory manipulation, and R data input and output. Rather than a complete collection of functions, I will introduce the frequenty-used functions from my own R experience.

## Part I File and Directory Manipulation

R has a variety of functions for file and directory manipulation. The following are a few examples:

`setwd()` and `getwd()`: used to change or determine the current working directory. It's a good habit to set working directory before your data analysis as all results during your data analysis will be stored in the working directory.

`list.files()` and `list.dirs()`: returns a character vector of names of files or directories under the given directory.

`file.info()`: gives file size, creation time, directory vs. ordinary file status, and so on for each file whose name is in the argument, a character vector.

`file.create()` and `dir.create()`: creates files or directories with the given names if they do not already exist.

`file.exists()` and `dir.exists()`: returns a logical vector indicating whether the given file exists for each name in the first argument, a character vector.

`file.copy()` and `file.rename()`: moves files `from` source path `to` destination path. 

`file.remove()` and **`unlink()`**: deletes the files or directories specified by the first argument, a character vector.

```{r}
# set current working directory to DAE
setwd("/Users/tonytsai/Documents/R/DAE")
getwd()

# list all files including directories under current working directory DAE
list.files()
# extract file information for those files
file.info(list.files())
# list only directories under DAE
list.dirs()
# find all R scripts under DAE and give their full path names (or absolute paths)
list.files(recursive = TRUE, pattern = ".R$", full.names = TRUE)

# create a recursive directory under DAE/Lab2, which stores the TXT data 
# that will be read in Part III.
if(!dir.exists("Lab2/data/CMDSSS"))
  dir.create("Lab2/data/CMDSSS", recursive = TRUE)

# create a temporary directory under script
if(!dir.exists("script/tmp")) dir.create("script/tmp")
# create a temporary R script under tmp to say Hello World, Hello R!
file.create("script/tmp/tmp.R")
cat("print('Hello World, Hello R!')", file = "script/tmp/tmp.R")
# excute the R script
source("script/tmp/tmp.R")

# copy tmp.R to helloworld.R
file.copy("script/tmp/tmp.R", "script/helloworld.R")
list.files("script", recursive = TRUE)
# rename helloworld.R to hello.R
file.rename("script/helloworld.R", "script/hello.R")
list.files("script", recursive = TRUE)

# delete all R scripts under script directory except for 20150916.R
# attempt to delete inexistent hellworld.R
file.remove(c("script/hello.R", "script/helloworld.R"))
list.files("script", recursive = TRUE)
# delete the temporary directory that is not empty.
unlink("script/tmp", recursive = TRUE)
list.files("script")
```

To see all the file- and directory-related functions, type the following:

```{r, eval=FALSE}
?files
```

## Part II Capturing R Console Output

R provides functions to save the results that appear in your R Console into a text file.

`sink()`: diverts R output to a file connection.

**`capture.output()`**: sends R output to a character string or file connection.

```{r, eval=FALSE}
# type following codes in your Console
# divert R output to CO2.txt under data directory
sink(file = "data/CO2.txt")
# load R built-in dataset CO2. type ?CO2 to see the decription about CO2 dataset.
data("CO2")
# divert the first 14 rows of CO2
head(CO2, 14)
# end the divertion
sink()
```

```{r}
# sink() does not work in knitr, because it is already used internally to capture 
# results. To make it work, you have to use {} wrap up all aboving code in a 
# single expression and print results to Console explicitly.
{
  sink(file = "data/CO2.txt")
  data("CO2")
  print(head(CO2, 14))
  sink()
}
# the content of CO2.txt will be checked in Part III.
```

```{r}
# generate a vector containing a numeric sequence from 1 to 10
1:10
# send the output to variable x
x <- capture.output(1:10)
x
# divert the first 14 rows of CO2 dataset to CO2.txt
capture.output(head(CO2, 14), file = "data/CO2.txt")
```

## Part III Imports and Exports

Here I list some functions in R for reading and storing data in common formats, such as Plain Text (.txt), CSV (.csv), Excel (.xls, .xlsx), and dBase (.dbf). For large and complex data, databases are supposed to be used for management. 

**`read.table()`** and **`write.table()`**: reads a file in table format and creates a data frame from it.

**`read.csv()`** and **`write.csv()`**: reads a CSV file and creates a data frame from it. A standard [CSV](https://en.wikipedia.org/wiki/Comma-separated_values) file actually stores tabular data in plain text with values separated by comma.

`read.xlsx()` and `write.xlsx()`: reads and writes Excel 2007 and Excel 97/2000/XP/2003 files. They are from [xlsx](https://cran.r-project.org/web/packages/xlsx/index.html) package. There are some other packages for reading or/and Excel files, such as [openxlsx](https://cran.r-project.org/web/packages/openxlsx/index.html), [XLConnect](https://cran.r-project.org/web/packages/XLConnect/index.html), [readxl](https://cran.r-project.org/web/packages/readxl/index.html) and [WriteXLS](https://cran.r-project.org/web/packages/WriteXLS/index.html). Frankly, I am not used to reading and writing Excel files. I usually process Excel files by saving them as CSV files.

`read.dbf()` and `write.dbf()`: reads and writes dBase files. They are from [foreign](https://cran.r-project.org/web/packages/foreign/index.html) package, which provides functions for reading and writing data stored by Minitab, S, SAS, SPSS, Stata, dBase, .... The reason why I specially introduce how to read dBase files is that the attribute table of shape file is stored in .dbf format.

**`save()`** and **`load()`**: writes R objects to the specified file. The objects can be read back from the file later by using `load`.

`data()`: loads specified data sets, or list the available data sets.

```{r}
# read data in Plain Text
txt <- read.table(file = "data/CO2.txt")
# check the content of CO2.txt
str(txt)
# exttract data of Qn1 plant
Qn1 <- subset(txt, Plant == "Qn1")
# save Qn1 to .txt. 
# Though the file extension is .txt, the data is actually stored in a CSV format.
write.table(Qn1, file = "data/CO2-Qn1.txt", row.names = FALSE, quote = FALSE, sep = ",")

# save Qn1 to .csv
write.csv(Qn1, file = "data/CO2-Qn1.csv", row.names = FALSE, quote = FALSE)
# use read.csv to read CO2-Qn1.csv
# fileEncoding declares the encoding used on the file, which must be careful 
# when you read data containing Chinese on Windows. In such a situation, you can 
# try fileEncoding = "cp936".
# stringsAsFactors is a logical value indicating whether character vectors should 
# be converted to factors. The default is TRUE, while some functions doesn't work
# with factors.
csv <- read.csv(file = "data/CO2-Qn1.csv", header = TRUE, sep = ",", 
                fileEncoding = "utf-8", stringsAsFactors = FALSE)
str(csv)

# install xlsx package
if(!"xlsx" %in% installed.packages()) install.packages("xlsx")
# load xlsx pacakage
library(xlsx)
# write Qn1 to .xls
write.xlsx(Qn1, file = "data/CO2-Qn1.xls", sheetName = "Sheet1", col.names = TRUE, 
           row.names = FALSE)
# use read.xlsx to read CO2-Qn1.xls 
xlsx <- read.xlsx(file = "data/CO2-Qn1.xls", sheetName = "Sheet1")
str(xlsx)

# install foreign package
if(!"foreign" %in% installed.packages()) install.packages("foreign")
# load foreign pacakage
library(foreign)
# write Qn1 to .dbf
write.dbf(Qn1, file = "data/CO2-Qn1.dbf")
# use read.dbf to read CO2-Qn1.dbf
dbf <- read.dbf(file = "data/CO2-Qn1.dbf")
str(dbf)

# list objects in current environment
ls()
# save txt, csv, xlsx and dbf .RData or .rda
save(txt, csv, xlsx, dbf, file = "data/format.RData")
# remove txt, csv, xlsx and dbf from current environment
rm(txt, csv, xlsx, dbf)
ls()
# load format.RData
load(file = "data/format.RData")
# list objects in current environment
ls()
```

### Demostration

The `SURF_CLI_CHN_MUL_DAY-TEM-12001-201409.TXT` contains daily temporature collected from all meteorological stations across China in September 2014, which is downloaded from the dataset of **SURF_CLI_CHN_MUL_DAY** v3.0 produced by [CMDSSS](http://cdc.nmic.cn/dataSetLogger.do?changeFlag=dataLogger). The following code demostrates how to preprocess the **SURF_CLI_CHN_MUL_DAY** dataset and extract your desired data in R, which is from my own research.

```{r}
# use read.table to read dataset in TXT
data <- read.table(file = "data/CMDSSS/SURF_CLI_CHN_MUL_DAY-TEM-12001-201409.TXT")
str(data)
# V1: station id
# V2: latitude, the last two digits are minitue and the remaining digits are degrees
# V3: longitude, the last two digits are minitue and the remaining digits are degrees
# V4: altitude in 0.1 meter. When the station altitude is estimated rather than 
#     measured, 100000 is added.
# V5: year
# V6: month
# V7: days of the month
# V8: average temperature in 0.1 degree Celsius
# V9: daily maximum temperature in 0.1 degree Celsius
# V10: daily minimum temperature in 0.1 degress Celsius.
#      When the actual temperature is higher than the higher limit of the instrument 
#      measuring range, 10000 is added; When the actual temperature is lower than the 
#      lower limit, 10000 is subtracted.
#      32766 indicates observations are not available (NA).
# V11: quality control code of average temperature
# V12: quality control code of daily maximum temperature
# V13: quality control code of daily minimum temperature
colnames(data) <- c("id", "lat", "lng", "alt", "year", "month", "day", "meanT", 
                    "maxT", "minT", "meanQC", "maxQC", "minQC")

# convert dm (the last two digits of dm represent minitue) into degree
DM2D <- function(dm) {
  dm %/% 100 + (dm %% 100) / 60
}

# process function for temperature
process <- function(df) {
  df[, 2:3] <- DM2D(df[, 2:3]) # latitude and longitude
  df[, 4] <- ifelse(df[, 4] > 100000, df[, 4] - 100000, df[, 4]) # altitude
  # add a date-time variable for convenient date-time calculation
  df$ymd <- ISOdate(df$year, df$month, df$day) 
  df[df[, 8] == 32766, 8] <- NA
  df[df[, 9] == 32766, 9] <- NA
  df[df[, 10] == 32766, 10] <- NA
  df[, 8:10] <- df[, 8:10] / 10
  df
}

data <- process(data)
str(data)

# extract data collected from Miyun station whose id is 54416 and discard quality control codes
x <- subset(data[, !names(data) %in% c("meanQC", "maxQC", "minQC")], id == 54416)
str(x)
# summaries of meanT, maxT, and minT
summary(x[, c("meanT", "maxT", "minT")])

# save the extracted data to external file for further data analysis
save(x, file = "data/Miyun-TEM-201409.RData")
```

## References

The following are materials on R data import/export that you can access on the Web.

- [R Data Import/Export](https://cran.r-project.org/doc/manuals/r-release/R-data.html)
